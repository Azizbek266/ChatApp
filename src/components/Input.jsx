import React, { useContext, useState } from "react";
import Img from "../img/img.png";
import { AuthContext } from "../context/AuthContext";
import { ChatContext } from "../context/ChatContext";
import './style.css'
import {
  arrayUnion,
  doc,
  serverTimestamp,
  Timestamp,
  updateDoc,
} from "firebase/firestore";
import { db, storage } from "../firebase";
import { getDownloadURL, ref, uploadBytesResumable } from "firebase/storage";
import { v4 as uuid } from "uuid";
import Sand from "../img/send.png";

const Input = () => {
  const [showEmojiPicker, setShowEmojiPicker] = useState(false);
  const [text, setText] = useState("");
  const [img, setImg] = useState(null)

  const { currentUser } = useContext(AuthContext);
  const { data } = useContext(ChatContext);

  const emojis = ["ðŸ˜€", "ðŸ˜", "ðŸ˜‚", "ðŸ¤£", "ðŸ˜ƒ", "ðŸ˜„", "ðŸ˜…", "ðŸ˜†", "ðŸ˜‰", "ðŸ˜Š", "ðŸ˜‹", "ðŸ˜Ž", "ðŸ˜", "ðŸ˜˜", "ðŸ˜—", "ðŸ˜™", "ðŸ˜š", "ðŸ™‚", "ðŸ¤—", "ðŸ¤”", "ðŸ˜", "ðŸ˜‘", "ðŸ˜¶", "ðŸ™„", "ðŸ˜", "ðŸ˜£", "ðŸ˜¥", "ðŸ˜®", "ðŸ¤", "ðŸ˜¯", "ðŸ˜ª", "ðŸ˜«", "ðŸ˜´", "ðŸ˜Œ", "ðŸ˜›", "ðŸ˜œ", "ðŸ˜", "ðŸ¤¤", "ðŸ˜’", "ðŸ˜“", "ðŸ˜”", "ðŸ˜•", "ðŸ™ƒ", "ðŸ¤‘", "ðŸ˜²", "ðŸ™", "ðŸ˜–", "ðŸ˜ž", "ðŸ˜Ÿ", "ðŸ˜¤", "ðŸ˜¢", "ðŸ˜­", "ðŸ˜¦", "ðŸ˜§", "ðŸ˜¨", "ðŸ˜©", "ðŸ¤¯", "ðŸ˜¬", "ðŸ˜°", "ðŸ˜±", "ðŸ˜³", "ðŸ¤ª", "ðŸ˜µ", "ðŸ˜·", "ðŸ¤’", "ðŸ¤•", "ðŸ¤¢", "ðŸ¤®", "ðŸ¥µ", "ðŸ¥¶", "ðŸ˜‡", "ðŸ¤ ", "ðŸ¥³", "ðŸ¥´", "ðŸ¥º", "ðŸ¤¯", "ðŸ¤«", "ðŸ¤­", "ðŸ§", "ðŸ¤“", "ðŸ˜ˆ", "ðŸ‘¿", "ðŸ‘¹", "ðŸ‘º", "ðŸ’€", "ðŸ‘»", "ðŸ‘½", "ðŸ¤–", "ðŸ’©", "ðŸ™ˆ", "ðŸ™‰", "ðŸ™Š", "ðŸ’¥", "ðŸ’«", "ðŸ’¦", "ðŸ’¨", "ðŸ”¥", "ðŸŒªï¸", "ðŸŒˆ", "â˜€ï¸", "ðŸŒ¤ï¸", "â›…", "ðŸŒ¥ï¸", "â˜ï¸", "ðŸŒ¦ï¸", "ðŸŒ§ï¸", "â›ˆï¸", "ðŸŒ©ï¸", "â„ï¸", "ðŸŒ¨ï¸", "â˜ƒï¸", "â›„", "ðŸŒ¬ï¸", "ðŸ’§", "ðŸ’¦", "ðŸŒŠ", "ðŸ¤™", "ðŸ¤ž", "ðŸ¤Ÿ", "ðŸ¤˜", "ðŸ¤š", "ðŸ‘‹", "ðŸ¤", "ðŸ‘", "ðŸ‘Ž", "ðŸ‘Š", "âœŠ", "ðŸ¤›", "ðŸ¤œ", "ðŸ¤š", "ðŸ‘Œ", "ðŸ‘ˆ", "ðŸ‘‰", "ðŸ‘†", "ðŸ‘‡", "â˜ï¸", "âœ‹", "ðŸ¤š", "ðŸ–ï¸", "ðŸ‘‹", "ðŸ¤™", "ðŸ’ª", "ðŸ¦¾", "ðŸ¦µ", "ðŸ¦¿", "ðŸ¦¶", "ðŸ‘‚", "ðŸ‘ƒ", "ðŸ§ ", "ðŸ¦·", "ðŸ¦´", "ðŸ‘€", "ðŸ‘ï¸", "ðŸ‘…", "ðŸ‘„", "ðŸ‘¶", "ðŸ§’", "ðŸ‘¦", "ðŸ‘§", "ðŸ§‘", "ðŸ‘±", "ðŸ‘¨", "ðŸ§”", "ðŸ‘´", "ðŸ‘µ", "ðŸ‘²", "ðŸ‘³", "ðŸ§•", "ðŸ‘®", "ðŸ‘·", "ðŸ’‚", "ðŸ•µï¸", "ðŸ‘©â€ðŸŒ¾", "ðŸ‘¨â€ðŸŒ¾", "ðŸ‘©â€ðŸ³", "ðŸ‘¨â€ðŸ³", "ðŸ‘©â€ðŸŽ“", "ðŸ‘¨â€ðŸŽ“", "ðŸ‘©â€ðŸŽ¤", "ðŸ‘¨â€ðŸŽ¤", "ðŸ‘©â€ðŸ«", "ðŸ‘¨â€ðŸ«", "ðŸ‘©â€ðŸ­", "ðŸ‘¨â€ðŸ­", "ðŸ‘©â€ðŸ’»", "ðŸ‘¨â€ðŸ’»", "ðŸ‘©â€ðŸ’¼", "ðŸ‘¨â€ðŸ’¼", "ðŸ‘©â€ðŸ”§", "ðŸ‘¨â€ðŸ”§", "ðŸ‘©â€ðŸ”¬", "ðŸ‘¨â€ðŸ”¬", "ðŸ‘©â€ðŸŽ¨", "ðŸ‘¨â€ðŸŽ¨", "ðŸ‘©â€ðŸš’", "ðŸ‘¨â€ðŸš’", "ðŸ‘©â€âœˆï¸", "ðŸ‘¨â€âœˆï¸", "ðŸ‘©â€ðŸš€", "ðŸ‘¨â€ðŸš€", "ðŸ‘©â€âš–ï¸", "ðŸ‘¨â€âš–ï¸", "ðŸ‘°", "ðŸ¤µ", "ðŸ‘¸", "ðŸ¤´", "ðŸ§", "ðŸ§š", "ðŸ§ž", "ðŸ§›", "ðŸ§Ÿ", "ðŸ’ƒ", "ðŸ•º", "ðŸ‘¯", "ðŸ‘¯â€â™‚ï¸", "ðŸ•´ï¸", "ðŸŽ­", "ðŸŽ¨", "ðŸŽ¬", "ðŸŽ¤", "ðŸŽ§", "ðŸŽ¹", "ðŸ¥", "ðŸŽ·", "ðŸŽº", "ðŸŽ¸", "ðŸª•", "ðŸŽ»", "ðŸŽ²", "ðŸ§©", "â™Ÿï¸", "ðŸŽ¯", "ðŸŽ³", "ðŸŽ®", "ðŸ•¹ï¸", "ðŸŽ°", "ðŸ•°ï¸", "â°", "â±ï¸", "â²ï¸", "ðŸ•°ï¸", "ðŸŒ", "ðŸŒŽ", "ðŸŒ", "ðŸŒ", "ðŸ—ºï¸", "ðŸ—¾", "ðŸ§­", "ðŸ”ï¸", "â›°ï¸", "ðŸŒ‹", "ðŸ—»", "ðŸ•ï¸", "ðŸ–ï¸", "ðŸœï¸", "ðŸï¸", "ðŸžï¸", "ðŸŸï¸", "ðŸ›ï¸", "ðŸ—ï¸", "ðŸ§±", "ðŸ˜ï¸", "ðŸšï¸", "ðŸ ", "ðŸ¡", "ðŸ¢", "ðŸ£", "ðŸ¤", "ðŸ¥", "ðŸ¦", "ðŸ¨", "ðŸ©", "ðŸª", "ðŸ«", "ðŸ¬", "ðŸ­", "ðŸ¯", "ðŸ°", "ðŸ’’", "ðŸ—¼", "ðŸ—½", "â›ª", "ðŸ•Œ", "ðŸ›•", "ðŸ•", "â›©ï¸", "ðŸ•‹", "â›²", "â›º", "ðŸŒ", "ðŸŒƒ", "ðŸ™ï¸", "ðŸŒ„", "ðŸŒ…", "ðŸŒ†", "ðŸŒ‡", "ðŸŒ‰", "â™¨ï¸", "ðŸŽ ", "ðŸŽ¡", "ðŸŽ¢", "ðŸ’ˆ", "ðŸŽª", "ðŸš‚", "ðŸšƒ", "ðŸš„", "ðŸš…", "ðŸš†", "ðŸš‡", "ðŸšˆ", "ðŸš‰", "ðŸšŠ", "ðŸš", "ðŸšž", "ðŸš‹", "ðŸšŒ", "ðŸš", "ðŸšŽ", "ðŸš", "ðŸš‘", "ðŸš’", "ðŸš“", "ðŸš”", "ðŸš•", "ðŸš–", "ðŸš—", "ðŸš˜", "ðŸš™", "ðŸšš", "ðŸš›", "ðŸšœ", "ðŸŽï¸", "ðŸï¸", "ðŸ›µ", "ðŸ¦½", "ðŸ¦¼", "ðŸ›´", "ðŸš²", "ðŸ›¹", "ðŸ›¼", "ðŸ›¬", "ðŸ›«", "âœˆï¸", "ðŸ›¸", "ðŸš€", "ðŸ›°ï¸", "ðŸ’º", "ðŸ›¶", "ðŸš¤", "ðŸ›¥ï¸", "ðŸ›³ï¸", "â›µ", "ðŸ›«", "ðŸ›¬", "ðŸš", "ðŸšŸ", "ðŸš ", "ðŸš¡", "ðŸ›¬", "ðŸ›«", "ðŸ›°ï¸", "ðŸš€", "ðŸš£", "ðŸš¤", "ðŸ›¶", "ðŸš¤", "ðŸ›¥ï¸", "ðŸ›³ï¸", "ðŸ›«", "ðŸ›¬", "ðŸ›¸", "ðŸ›©ï¸", "ðŸš", "ðŸš†", "ðŸš‡", "ðŸšˆ", "ðŸšŠ", "ðŸš", "ðŸšž", "ðŸš‹", "ðŸšž", "ðŸµ", "ðŸ¦", "ðŸ¦§", "ðŸ¶", "ðŸ•", "ðŸ¦®", "ðŸ•â€ðŸ¦º", "ðŸ©", "ðŸº", "ðŸ¦Š", "ðŸ¦", "ðŸ±", "ðŸˆ", "ðŸˆâ€â¬›", "ðŸ¦", "ðŸ¯", "ðŸ…", "ðŸ†", "ðŸ´", "ðŸŽ", "ðŸ¦„", "ðŸ¦“", "ðŸ¦Œ", "ðŸ®", "ðŸ‚", "ðŸƒ", "ðŸ„", "ðŸ·", "ðŸ–", "ðŸ—", "ðŸ", "ðŸ‘", "ðŸ", "ðŸ¦™", "ðŸ¦’", "ðŸ˜", "ðŸ¦", "ðŸ¦›", "ðŸ­", "ðŸ", "ðŸ€", "ðŸ¹", "ðŸ°", "ðŸ‡", "ðŸ¿ï¸", "ðŸ¦”", "ðŸ¦‡", "ðŸ»", "ðŸ¨", "ðŸ¼", "ðŸ¦¥", "ðŸ¦¦", "ðŸ¦¨", "ðŸ¦©", "ðŸ¾", "ðŸ¦®", "ðŸ¦¥", "ðŸ¦¦", "ðŸ", "ðŸ²", "ðŸ‰", "ðŸ¦•", "ðŸ¦–", "ðŸ¢", "ðŸŠ", "ðŸâ€", "ðŸ²â€", "ðŸ¦–â€", "ðŸ¦•â€", "ðŸ™", "ðŸ¦‘", "ðŸ¦", "ðŸ¦ž", "ðŸ¦€", "ðŸ¡", "ðŸ ", "ðŸŸ", "ðŸ¬", "ðŸ³", "ðŸ‹", "ðŸ¦ˆ", "ðŸŠ", "ðŸ¢", "ðŸ¦Ž", "ðŸ", "ðŸ²", "ðŸ‰", "ðŸŒµ", "ðŸŽ„", "ðŸŒ²", "ðŸŒ³", "ðŸŒ´", "ðŸŒ±", "ðŸŒ¿", "â˜˜ï¸", "ðŸ€", "ðŸŽ", "ðŸ„", "ðŸ…", "ðŸ†", "ðŸ¥‘", "ðŸ¥¦", "ðŸ¥’", "ðŸŒ¶ï¸", "ðŸŒ½", "ðŸ¥•", "ðŸ¥”", "ðŸ ", "ðŸ¥œ", "ðŸŒ°", "ðŸ¯", "ðŸž", "ðŸ¥", "ðŸ¥–", "ðŸ§€", "ðŸ–", "ðŸ—", "ðŸ¥©", "ðŸ¥“", "ðŸ”", "ðŸŸ", "ðŸ•", "ðŸŒ­", "ðŸ¥ª", "ðŸ¥™", "ðŸŒ®", "ðŸŒ¯", "ðŸ¥—", "ðŸ¥˜", "ðŸ²", "ðŸ¥£", "ðŸ±", "ðŸ˜", "ðŸ™", "ðŸš", "ðŸ›", "ðŸœ", "ðŸ", "ðŸ ", "ðŸ¢", "ðŸ£", "ðŸ¤", "ðŸ¥", "ðŸ¡", "ðŸ¥Ÿ", "ðŸ¥ ", "ðŸ¥¡", "ðŸ¦", "ðŸ§", "ðŸ¨", "ðŸ©", "ðŸª", "ðŸŽ‚", "ðŸ°", "ðŸ§", "ðŸ¥§", "ðŸ«", "ðŸ¬", "ðŸ­", "ðŸ®", "ðŸ¯", "ðŸ¼", "ðŸ¥›", "â˜•", "ðŸµ", "ðŸ¶", "ðŸ¾", "ðŸ·", "ðŸ¸", "ðŸ¹", "ðŸº", "ðŸ»", "ðŸ¥‚", "ðŸ¥ƒ", "ðŸ¥¤", "ðŸ¼", "ðŸº", "ðŸ»", "ðŸ¥‚", "ðŸ¥ƒ", "ðŸ¥¤", "ðŸ¥¢", "ðŸ´", "ðŸ¥„", "ðŸ”ª", "ðŸº", "ðŸŒ°", "ðŸ±", "ðŸ¾", "ðŸ¶", "ðŸ§‰", "ðŸ¾", "ðŸ¶", "ðŸº", "ðŸ»", "ðŸ¹", "ðŸ·", "ðŸ¥¤", "ðŸ§Š", "ðŸš’", "ðŸš‘", "ðŸš“", "ðŸš•", "ðŸ›´", "ðŸ›µ", "ðŸš²", "ðŸš‚", "ðŸš†", "ðŸš…", "ðŸš€", "ðŸ›¸", "ðŸ›°ï¸", "ðŸš", "ðŸ›©ï¸", "ðŸ›«", "ðŸ›¬", "ðŸ›¥ï¸", "ðŸš¤", "ðŸ›³ï¸", "â›´ï¸", "ðŸ›´", "ðŸš²", "ðŸ›¹", "ðŸ›´", "ðŸŽï¸", "ðŸï¸", "ðŸ›µ", "ðŸ›º", "ðŸšœ", "ðŸš›", "ðŸšš", "ðŸš—", "ðŸš™", "ðŸšŒ", "ðŸšŽ", "ðŸ ", "ðŸ¢", "ðŸ£", "ðŸ¤", "ðŸ¥", "ðŸ¦", "ðŸ¨", "ðŸ©", "ðŸª", "ðŸ«", "ðŸ¬", "ðŸ­", "ðŸ¯", "ðŸ°", "â›©ï¸", "ðŸ—¼", "ðŸ—½", "ðŸ•Œ", "ðŸ•", "â›ª", "ðŸ›•", "ðŸ›–", "ðŸ•‹", "ðŸ›¤ï¸", "ðŸ›£ï¸", "ðŸ—¾", "ðŸžï¸", "ðŸŒ…", "ðŸŒ„", "ðŸŒ‡", "ðŸŒ†", "ðŸ™ï¸", "ðŸŒƒ", "ðŸŒ‰", "ðŸŒ", "ðŸŒŒ", "ðŸŒ ", "ðŸŽ†", "ðŸŽ‡", "ðŸŒˆ", "ðŸŽ¨", "ðŸ–¼ï¸", "ðŸŽ­", "ðŸŽ¬", "ðŸŽ¤", "ðŸŽ§", "ðŸŽ¼", "ðŸŽ¹", "ðŸ¥", "ðŸŽ·", "ðŸŽº", "ðŸŽ¸", "ðŸŽ»", "ðŸŽ²", "ðŸŽ®", "ðŸ•¹ï¸", "ðŸŽ¯", "ðŸŽ³", "ðŸŽ°", "ðŸŽ²", "ðŸ§©", "â™Ÿï¸", "ðŸŽ­", "ðŸŽ¬", "ðŸŽ¤", "ðŸŽ§", "ðŸŽ¼", "ðŸŽ¹", "ðŸ¥", "ðŸŽ·", "ðŸŽº", "ðŸŽ¸", "ðŸŽ»", "ðŸŽ¥", "ðŸŽžï¸", "ðŸ“½ï¸", "ðŸ“º", "ðŸŽ™ï¸", "ðŸŽšï¸", "ðŸŽ›ï¸", "ðŸŽ¡", "ðŸŽ¢", "ðŸŽ ", "ðŸŸï¸", "ðŸŽª", "ðŸŽ«", "ðŸŽ–ï¸", "ðŸ…", "ðŸŽ—ï¸", "ðŸ†", "ðŸ¥‡", "ðŸ¥ˆ", "ðŸ¥‰", "ðŸµï¸", "ðŸŽ–ï¸", "ðŸ°", "ðŸ›•", "ðŸ•", "â›©ï¸", "ðŸ¯", "ðŸŸï¸", "ðŸŽ¢", "ðŸŽ¡", "ðŸŽ ", "ðŸš¨", "ðŸš”", "ðŸš¨", "ðŸš”", "ðŸš", "ðŸš", "ðŸš’", "ðŸ‡", "ðŸˆ", "ðŸ‰", "ðŸŠ", "ðŸ‹", "ðŸŒ", "ðŸ", "ðŸŽ", "ðŸ", "ðŸ", "ðŸ‘", "ðŸ’", "ðŸ“", "ðŸ¥", "ðŸ…", "ðŸ¥‘", "ðŸ¥’", "ðŸ¥•", "ðŸŒ½", "ðŸŒ¶ï¸", "ðŸ¥”", "ðŸ ", "ðŸ¥œ", "ðŸ¯", "ðŸ¥", "ðŸž", "ðŸ¥–", "ðŸ¥¨", "ðŸ§€", "ðŸ¥š", "ðŸ³", "ðŸ¥“", "ðŸ¥©", "ðŸ”", "ðŸŸ", "ðŸ•", "ðŸŒ­", "ðŸ¥ª", "ðŸ¥™", "ðŸŒ®", "ðŸŒ¯", "ðŸ¥—", "ðŸ¥˜", "ðŸ²", "ðŸ¥£", "ðŸ¥«", "ðŸ±", "ðŸ˜", "ðŸ™", "ðŸš", "ðŸ›", "ðŸœ", "ðŸ", "ðŸ ", "ðŸ¢", "ðŸ£", "ðŸ¤", "ðŸ¥", "ðŸ¥®", "ðŸ¡", "ðŸ¥Ÿ", "ðŸ¥ ", "ðŸ¦", "ðŸ§", "ðŸ¨", "ðŸ©", "ðŸª", "ðŸŽ‚", "ðŸ°", "ðŸ§", "ðŸ¥§", "ðŸ«", "ðŸ¬", "ðŸ­", "ðŸ®", "ðŸ¯", "ðŸ¼", "ðŸ¥›", "â˜•", "ðŸµ", "ðŸ¶", "ðŸ¾", "ðŸ·", "ðŸ¸", "ðŸ¹", "ðŸº", "ðŸ»", "ðŸ¥‚", "ðŸ¥ƒ", "ðŸ¥¤", "ðŸ§ƒ", "ðŸ§‰", "ðŸ¥¢", "ðŸ½ï¸", "ðŸ´", "ðŸ¥„", "ðŸ”ª", "ðŸº", "ðŸ§Š", "ðŸ¥¤", "ðŸ¼", "ðŸ¥›", "ðŸ¥‚", "ðŸº", "ðŸ½ï¸", "ðŸ´", "ðŸ¥„", "ðŸ”ª", "ðŸ¥¢", "ðŸº", "ðŸ§Š", "ðŸ”¥", "ðŸŒªï¸", "ðŸŒŠ", "ðŸ’§", "ðŸ’¦", "â˜‚ï¸", "â˜”", "â„ï¸", "ðŸŒ¬ï¸", "ðŸŒ€", "ðŸŒ", "ðŸŒƒ", "ðŸŒ„", "ðŸŒ…", "ðŸŒ†", "ðŸŒ‡", "ðŸŒ‰", "ðŸŒŒ", "ðŸŒ ", "ðŸŽ‡", "ðŸŽ†", "ðŸŒˆ", "ðŸŽ­", "ðŸŽ¨", "ðŸŽ¼", "ðŸŽ¹", "ðŸŽ¤", "ðŸŽ§", "ðŸŽ¬"]

  const handleSend = async () => {
    if (text !== "" || img !== null) {
      if (img) {
        const storageRef = ref(storage, uuid());
        const uploadTask = uploadBytesResumable(storageRef, img);
        uploadTask.on(
          (error) => { },
          () => {
            getDownloadURL(uploadTask.snapshot.ref).then(async (downloadURL) => {
              await updateDoc(doc(db, "chats", data.chatId), {
                messages: arrayUnion({
                  id: uuid(),
                  text,
                  senderId: currentUser.uid,
                  date: Timestamp.now(),
                  img: downloadURL,
                }),
              });
            });
          }
        );
      } else {
        await updateDoc(doc(db, "chats", data.chatId), {
          messages: arrayUnion({
            id: uuid(),
            text,
            senderId: currentUser.uid,
            date: Timestamp.now(),
          }),
        });
      }

      await updateDoc(doc(db, "userChats", currentUser.uid), {
        [data.chatId + ".lastMessage"]: {
          text,
        },
        [data.chatId + ".date"]: serverTimestamp(),
      });

      await updateDoc(doc(db, "userChats", data.user.uid), {
        [data.chatId + ".lastMessage"]: {
          text,
        },
        [data.chatId + ".date"]: serverTimestamp(),
      });

      setText("");
      setImg(null);
      setShowEmojiPicker(false);
    }
  };

  document.onkeydown = function (e) {
    if (e.keyCode === 13) {
      handleSend();
      setText("");
      setImg(null);
      setShowEmojiPicker(false);
    }
  };

  return (
    <div className="input">
      {showEmojiPicker && (
        <div className="emoji-picker">
          {emojis.map((emoji) => (
            <span key={emoji} onClick={() => setText(text + emoji)}>
              {emoji}
            </span>
          ))}
        </div>
      )}
      <button id="icons" onClick={() => setShowEmojiPicker(!showEmojiPicker)}>ðŸ˜€</button>
      <input
        type="text"
        placeholder="Xabar yozing..."
        onChange={(e) => setText(e.target.value)}
        value={text}
      />
      <div className="send">
        <input
          type="file"
          style={{ display: "none" }}
          id="file"
          onChange={(e) => setImg(e.target.files[0])}
        />
        <label htmlFor="file">
          <img src={Img} alt="" />
        </label>
        <button onClick={handleSend}>Send</button>
      </div>
</div>
);
};

export default Input;